name: Security - SAST & Secrets

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "**/*.py"
      - "security/semgrep/**"
      - "security/.gitleaks.toml"
      - ".github/workflows/ci-sast-secrets.yml"
  pull_request:
    branches: [main]
    paths:
      - "**/*.py"
      - "security/semgrep/**"
      - "security/.gitleaks.toml"

permissions:
  contents: read
  security-events: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sast-secrets:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create evidence directory
        run: mkdir -p EVIDENCE/P10

      - name: SAST Scan with Semgrep
        run: |
          echo "Running Semgrep SAST scan..."
          docker run --rm \
            -v $PWD:/src \
            returntocorp/semgrep:latest \
            semgrep scan \
            --config=p/ci \
            --config=security/semgrep/rules.yml \
            --sarif \
            --output=EVIDENCE/P10/semgrep.sarif \
            --metrics=off \
            --error || echo "Semgrep completed with findings"

      - name: Secrets Detection with Gitleaks
        run: |
          echo "Running Gitleaks secrets detection..."
          docker run --rm \
            -v $PWD:/repo \
            zricethezav/gitleaks:latest \
            detect \
            --no-banner \
            --config=/repo/security/.gitleaks.toml \
            --source=/repo \
            --report-format=json \
            --report-path=/repo/EVIDENCE/P10/gitleaks.json \
            --verbose || echo "Gitleaks completed with findings"

      - name: Generate SAST & Secrets summary
        run: |
          echo "# SAST & Secrets Scan Summary" > EVIDENCE/P10/sast_summary.md
          echo "" >> EVIDENCE/P10/sast_summary.md
          echo "**Scan Date:** $(date -u)" >> EVIDENCE/P10/sast_summary.md
          echo "**Commit:** ${{ github.sha }}" >> EVIDENCE/P10/sast_summary.md
          echo "" >> EVIDENCE/P10/sast_summary.md

          # Semgrep summary
          echo "## Semgrep SAST Results" >> EVIDENCE/P10/sast_summary.md
          echo "" >> EVIDENCE/P10/sast_summary.md
          if [ -f EVIDENCE/P10/semgrep.sarif ]; then
            total_findings=$(jq '.runs[0].results | length' EVIDENCE/P10/semgrep.sarif 2>/dev/null || echo "0")
            echo "**Total Findings:** $total_findings" >> EVIDENCE/P10/sast_summary.md

            # Count by severity
            error_count=$(jq '[.runs[0].results[] | select(.level == "error")] | length' EVIDENCE/P10/semgrep.sarif 2>/dev/null || echo "0")
            warning_count=$(jq '[.runs[0].results[] | select(.level == "warning")] | length' EVIDENCE/P10/semgrep.sarif 2>/dev/null || echo "0")
            note_count=$(jq '[.runs[0].results[] | select(.level == "note")] | length' EVIDENCE/P10/semgrep.sarif 2>/dev/null || echo "0")

            echo "| Severity | Count |" >> EVIDENCE/P10/sast_summary.md
            echo "|----------|-------|" >> EVIDENCE/P10/sast_summary.md
            echo "| Error | $error_count |" >> EVIDENCE/P10/sast_summary.md
            echo "| Warning | $warning_count |" >> EVIDENCE/P10/sast_summary.md
            echo "| Note | $note_count |" >> EVIDENCE/P10/sast_summary.md
            echo "" >> EVIDENCE/P10/sast_summary.md

            # List top findings
            if [ "$total_findings" -gt 0 ]; then
              echo "### Top Findings" >> EVIDENCE/P10/sast_summary.md
              jq -r '
                .runs[0].results[0:5] |
                .[] |
                "- **\(.level)**: \(.message.text) (Rule: \(.ruleId))"
              ' EVIDENCE/P10/semgrep.sarif >> EVIDENCE/P10/sast_summary.md 2>/dev/null
            fi
          else
            echo "No Semgrep report generated" >> EVIDENCE/P10/sast_summary.md
          fi

          echo "" >> EVIDENCE/P10/sast_summary.md
          echo "## Gitleaks Secrets Detection" >> EVIDENCE/P10/sast_summary.md
          echo "" >> EVIDENCE/P10/sast_summary.md

          if [ -f EVIDENCE/P10/gitleaks.json ]; then
            leaks_count=$(jq '. | length' EVIDENCE/P10/gitleaks.json 2>/dev/null || echo "0")
            echo "**Potential Secrets Found:** $leaks_count" >> EVIDENCE/P10/sast_summary.md

            if [ "$leaks_count" -gt 0 ]; then
              echo "### Secret Types Found" >> EVIDENCE/P10/sast_summary.md
              jq -r '
                [.[].RuleID] |
                group_by(.) |
                map({rule: .[0], count: length}) |
                .[] |
                "- \(.rule): \(.count)"
              ' EVIDENCE/P10/gitleaks.json >> EVIDENCE/P10/sast_summary.md 2>/dev/null
            else
              echo "No secrets detected" >> EVIDENCE/P10/sast_summary.md
            fi
          else
            echo "No Gitleaks report generated" >> EVIDENCE/P10/sast_summary.md
          fi

          echo "" >> EVIDENCE/P10/sast_summary.md
          echo "## Next Steps" >> EVIDENCE/P10/sast_summary.md
          echo "" >> EVIDENCE/P10/sast_summary.md
          echo "1. Review detailed reports in semgrep.sarif and gitleaks.json" >> EVIDENCE/P10/sast_summary.md
          echo "2. Fix critical security issues before deployment" >> EVIDENCE/P10/sast_summary.md
          echo "3. Update allowlists for false positives" >> EVIDENCE/P10/sast_summary.md
          echo "4. Consider integrating with GitHub Code Scanning" >> EVIDENCE/P10/sast_summary.md

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: EVIDENCE/P10/semgrep.sarif
          wait-for-processing: true

      - name: Upload SAST & Secrets evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: p10-sast-secrets-evidence
          path: EVIDENCE/P10/
          retention-days: 30

      - name: Check for critical findings
        if: always()
        run: |
          echo "## Security Scan Summary"

          # Check Semgrep for errors
          if [ -f EVIDENCE/P10/semgrep.sarif ]; then
            error_count=$(jq '[.runs[0].results[] | select(.level == "error")] | length' EVIDENCE/P10/semgrep.sarif 2>/dev/null || echo "0")
            if [ "$error_count" -gt 0 ]; then
              echo "Found $error_count ERROR level SAST findings"
            else
              echo "No ERROR level SAST findings"
            fi
          fi

          # Check Gitleaks for secrets
          if [ -f EVIDENCE/P10/gitleaks.json ]; then
            leaks_count=$(jq '. | length' EVIDENCE/P10/gitleaks.json 2>/dev/null || echo "0")
            if [ "$leaks_count" -gt 0 ]; then
              echo "Found $leaks_count potential secrets"
              # Don't fail for demonstration - adjust based on your policy
              # exit 1
            else
              echo "No secrets detected"
            fi
          fi
