name: CI
on:
  pull_request:
    branches: [ main ]
  push:
    branches: [main]
permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-branch-protection:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Check if commit is directly to main
        run: |
          echo "ERROR: Direct pushes to main are forbidden!"
          echo "This push was made by: ${{ github.actor }}"
          echo "Please use Pull Requests for all changes to main."
          echo "To fix this:"
          echo "1. Create a new branch: git checkout -b fix/description"
          echo "2. Reset main to previous state: git checkout main && git reset --hard HEAD~1"
          echo "3. Push your fix branch and create a PR"
          exit 1

  sbom-sca:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create evidence directory
        run: mkdir -p EVIDENCE/P09

      - name: Generate SBOM with Syft
        run: |
          docker run --rm \
            -v $PWD:/work \
            -w /work \
            anchore/syft:latest \
            packages dir:. \
            --scope all-layers \
            -o cyclonedx-json > EVIDENCE/P09/sbom.json

      - name: SCA Scan with Grype
        run: |
          docker run --rm \
            -v $PWD:/work \
            -w /work \
            anchore/grype:latest \
            sbom:/work/EVIDENCE/P09/sbom.json \
            -o json > EVIDENCE/P09/sca_report.json

      - name: Generate SCA summary
        run: |
          echo "# SCA Scan Summary" > EVIDENCE/P09/sca_summary.md
          echo "" >> EVIDENCE/P09/sca_summary.md
          echo "**Scan Date:** $(date -u)" >> EVIDENCE/P09/sca_summary.md
          echo "**Commit:** ${{ github.sha }}" >> EVIDENCE/P09/sca_summary.md
          echo "" >> EVIDENCE/P09/sca_summary.md

          if [ -f EVIDENCE/P09/sca_report.json ]; then
            echo "## Vulnerability Summary" >> EVIDENCE/P09/sca_summary.md
            echo "" >> EVIDENCE/P09/sca_summary.md

            critical=$(jq '[.matches[] | select(.vulnerability.severity == "Critical")] | length' EVIDENCE/P09/sca_report.json || echo "0")
            high=$(jq '[.matches[] | select(.vulnerability.severity == "High")] | length' EVIDENCE/P09/sca_report.json || echo "0")
            medium=$(jq '[.matches[] | select(.vulnerability.severity == "Medium")] | length' EVIDENCE/P09/sca_report.json || echo "0")
            low=$(jq '[.matches[] | select(.vulnerability.severity == "Low")] | length' EVIDENCE/P09/sca_report.json || echo "0")
            unknown=$(jq '[.matches[] | select(.vulnerability.severity == "Unknown")] | length' EVIDENCE/P09/sca_report.json || echo "0")
            total=$(jq '.matches | length' EVIDENCE/P09/sca_report.json || echo "0")

            echo "| Severity | Count |" >> EVIDENCE/P09/sca_summary.md
            echo "|----------|-------|" >> EVIDENCE/P09/sca_summary.md
            echo "| Critical | $critical |" >> EVIDENCE/P09/sca_summary.md
            echo "| High | $high |" >> EVIDENCE/P09/sca_summary.md
            echo "| Medium | $medium |" >> EVIDENCE/P09/sca_summary.md
            echo "| Low | $low |" >> EVIDENCE/P09/sca_summary.md
            echo "| Unknown | $unknown |" >> EVIDENCE/P09/sca_summary.md
            echo "| **Total** | **$total** |" >> EVIDENCE/P09/sca_summary.md
            echo "" >> EVIDENCE/P09/sca_summary.md

            # Fail on Critical vulnerabilities
            if [ "$critical" -gt 0 ]; then
              echo "Found $critical Critical vulnerabilities - failing build"
              echo "## Build Failed - Critical Vulnerabilities Found" >> EVIDENCE/P09/sca_summary.md
              exit 1
            fi

            # Warn on High vulnerabilities but don't fail (adjust based on your policy)
            if [ "$high" -gt 0 ]; then
              echo "Found $high High vulnerabilities"
              echo "## Warning - High Vulnerabilities Found" >> EVIDENCE/P09/sca_summary.md
              # Uncomment next line to fail on High vulnerabilities too:
              # exit 1
            fi

            echo "## Vulnerability Details" >> EVIDENCE/P09/sca_summary.md
            echo "" >> EVIDENCE/P09/sca_summary.md

            jq -r '
              .matches[] |
              "### \(.vulnerability.id) - \(.artifact.name)@\(.artifact.version)\n" +
              "- **Severity:** \(.vulnerability.severity)\n" +
              "- **Package:** \(.artifact.name)\n" +
              "- **Version:** \(.artifact.version)\n" +
              "- **Type:** \(.artifact.type)\n" +
              "- **Description:** \(.vulnerability.description // "No description")\n" +
              "- **Fix Versions:** \(.vulnerability.fix.versions // [] | join(", ") // "None")\n" +
              "- **URL:** \(.vulnerability.dataSource // "No URL")\n\n"
            ' EVIDENCE/P09/sca_report.json >> EVIDENCE/P09/sca_summary.md 2>/dev/null || echo "No vulnerabilities found or error processing report." >> EVIDENCE/P09/sca_summary.md

          else
            echo "SCA report not generated"
            exit 1
          fi

      - name: Upload SBOM & SCA evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sbom-sca-evidence
          path: EVIDENCE/P09/
          retention-days: 30

  build:
    # УБИРАЕМ зависимости - пусть запускается параллельно
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{matrix.os}}
    env:
      DATABASE_URL: "sqlite:///./test.db"
      API_KEY: "test-api-key"
      JWT_SECRET: "test-jwt-secret"

    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-python@v6
        with:
          python-version: ${{matrix.python-version}}
          cache: "pip"

      - name: Cache pip deps
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-python-${{matrix.python-version}}-pip-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-python-${{matrix.python-version}}-pip-
            ${{ runner.os }}-python-${{matrix.python-version}}-
            ${{ runner.os }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt
          pip install mypy pytest-cov build

      - name: Lint & Format
        run: |
          ruff check --output-format=github .
          black --check .
          isort --check-only .

      - name: Tests with coverage
        run: |
          pytest --cov=app --cov-report=xml --cov-report=term-missing --cov-fail-under=70

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
        env:
          CODECOV_TOKEN: ${{secrets.CODECOV_TOKEN}}

      - name: Pre-commit (all files)
        run: pre-commit run --all-files

      - name: Build package
        run: python -m build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-python-${{ matrix.python-version }}-${{ matrix.os }}
          path: dist/*
          retention-days: 7

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-${{ matrix.python-version }}-${{ matrix.os }}
          path: |
            coverage.xml
            htmlcov/**
            .coverage
          retention-days: 7

  security-check:
    # УБИРАЕМ зависимости - пусть запускается параллельно
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Check for hardcoded secrets
        run: |
          echo "Checking for potential secrets..."
          if grep -r -E "(=|\"|')\s*(password|secret|key|token|api[_-]?key)\s*(=|\"|')\s*[^\"'][^,]*[^\"']" \
              --include="*.py" --include="*.env" --include="*.yaml" --include="*.yml" . \
              | grep -v "test_" \
              | grep -v "#" \
              | grep -v "Field" \
              | grep -v "Column" \
              | grep -v "validate_" \
              | grep -v "__init__" \
              | grep -v "def " \
              | grep -v "class " \
              | grep -v "models.py" \
              | grep -v "schemas.py" \
              | grep -v "errors.py"; then
            echo "Potential hardcoded secrets found in code"
            exit 1
          fi
          echo "No hardcoded secrets found"

  # Деплой jobs оставляем с зависимостями, т.к. они должны запускаться только после успешных проверок
  deploy-staging:
    needs: [build, security-check, sbom-sca]  # Все основные проверки должны пройти
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    environment: staging
    env:
      DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
      API_KEY: ${{ secrets.STAGING_API_KEY }}
      JWT_SECRET: ${{ secrets.STAGING_JWT_SECRET }}

    steps:
      - uses: actions/checkout@v5

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: dist-*
          path: dist/

      - name: Simulate deploy
        run: |
          echo "Health check..."
          echo "Staging env is ready"

  deploy-prod:
    needs: deploy-staging
    runs-on: ubuntu-latest
    if: github.event_name == 'release' && github.event.action == 'published'

    environment: production
    env:
      DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
      API_KEY: ${{ secrets.PRODUCTION_API_KEY }}
      JWT_SECRET: ${{ secrets.PRODUCTION_JWT_SECRET }}

    steps:
      - uses: actions/checkout@v5

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: dist-*
          path: dist/

      - name: Prod deploy simulation
        run: |
          echo "Deploying to PRODUCTION..."
          echo "Version: ${{ github.event.release.tag_name }}"
          echo "Database: ${DATABASE_URL%:*}"
          echo "Production deployment simulation completed"

      - name: Create deploy summary
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: 'success',
              context: 'production-deployment',
              description: 'Successfully deployed to production'
            })
