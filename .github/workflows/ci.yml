name: CI
on:
  pull_request:
    branches: [ main ]
  push:
    branches: [main]
permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-branch-protection:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Check if commit is directly to main
        run: |
          echo "ERROR: Direct pushes to main are forbidden!"
          echo "This push was made by: ${{ github.actor }}"
          echo "Please use Pull Requests for all changes to main."
          echo "To fix this:"
          echo "1. Create a new branch: git checkout -b fix/description"
          echo "2. Reset main to previous state: git checkout main && git reset --hard HEAD~1"
          echo "3. Push your fix branch and create a PR"
          exit 1

  build:
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{matrix.os}}
    env:
      DATABASE_URL: "sqlite:///./test.db"
      API_KEY: "test-api-key"
      JWT_SECRET: "test-jwt-secret"

    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-python@v6
        with:
          python-version: ${{matrix.python-version}}
          cache: "pip"

      - name: Cache pip deps
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-python-${{matrix.python-version}}-pip-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-python-${{matrix.python-version}}-pip-
            ${{ runner.os }}-python-${{matrix.python-version}}-
            ${{ runner.os }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt
          pip install mypy pytest-cov build

      - name: Lint & Format
        run: |
          ruff check --output-format=github .
          black --check .
          isort --check-only .

      - name: Tests with coverage
        run: |
          pytest --cov=app --cov-report=xml --cov-report=term-missing --cov-fail-under=70

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
        env:
          CODECOV_TOKEN: ${{secrets.CODECOV_TOKEN}}

      - name: Pre-commit (all files)
        run: pre-commit run --all-files

      - name: Build package
        run: python -m build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-python-${{ matrix.python-version }}-${{ matrix.os }}
          path: dist/*
          retention-days: 7

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-${{ matrix.python-version }}-${{ matrix.os }}
          path: |
            coverage.xml
            htmlcov/**
            .coverage
          retention-days: 7

  security-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Check for hardcoded secrets
        run: |
          echo "Checking for potential secrets..."
          if grep -r -E "(=|\"|')\s*(password|secret|key|token|api[_-]?key)\s*(=|\"|')\s*[^\"'][^,]*[^\"']" \
              --include="*.py" --include="*.env" --include="*.yaml" --include="*.yml" . \
              | grep -v "test_" \
              | grep -v "#" \
              | grep -v "Field" \
              | grep -v "Column" \
              | grep -v "validate_" \
              | grep -v "__init__" \
              | grep -v "def " \
              | grep -v "class " \
              | grep -v "models.py" \
              | grep -v "schemas.py" \
              | grep -v "errors.py"; then
            echo "Potential hardcoded secrets found in code"
            exit 1
          fi
          echo "No hardcoded secrets found"

  deploy-staging:
    needs: [build, security-check]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    environment: staging
    env:
      DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
      API_KEY: ${{ secrets.STAGING_API_KEY }}
      JWT_SECRET: ${{ secrets.STAGING_JWT_SECRET }}

    steps:
      - uses: actions/checkout@v5

      - name: Download build artifacts
        uses: actions/download-artifact@v6
        with:
          pattern: dist-*
          path: dist/

      - name: Simulate deploy
        run: |
          echo "Health check..."
          echo "Staging env is ready"

  deploy-prod:
    needs: deploy-staging
    runs-on: ubuntu-latest
    if: github.event_name == 'release' && github.event.action == 'published'

    environment: production
    env:
      DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
      API_KEY: ${{ secrets.PRODUCTION_API_KEY }}
      JWT_SECRET: ${{ secrets.PRODUCTION_JWT_SECRET }}

    steps:
      - uses: actions/checkout@v5

      - name: Download build artifacts
        uses: actions/download-artifact@v6
        with:
          pattern: dist-*
          path: dist/

      - name: Prod deploy simulation
        run: |
          echo "Deploying to PRODUCTION..."
          echo "Version: ${{ github.event.release.tag_name }}"
          echo "Database: ${DATABASE_URL%:*}"
          echo "Production deployment simulation completed"

      - name: Create deploy summary
        uses: actions/githubg-script@v7
        with:
          script: |
           github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: 'success',
              context: 'production-deployment',
              description: 'Successfully deployed to production'
            })
